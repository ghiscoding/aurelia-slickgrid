"use strict";(self.webpackChunkau_slickgrid_demo=self.webpackChunkau_slickgrid_demo||[]).push([[809],{6940:(t,e,s)=>{s.d(e,{r:()=>o});var i=s(5577),r=s(5832);class n{set columnDefinitions(t){this._columnDefinitions=t}set datasetIdPropName(t){this._datasetIdPropName=t}constructor(){this._filterCount=0,this._columnDefinitions=[],this._datasetIdPropName="id",this._odataOptions={filterQueue:[],orderBy:""},this._defaultSortBy="",this._columnFilters={}}buildQuery(){if(!this._odataOptions)throw new Error('Odata Service requires certain options like "top" for it to work');this._odataOptions.filterQueue=[];const t=[];if(this._odataOptions&&!0===this._odataOptions.enableCount){const e=this._odataOptions.version&&this._odataOptions.version>=4?"$count=true":"$inlinecount=allpages";t.push(e)}if(this._odataOptions.top&&t.push(`$top=${this._odataOptions.top}`),this._odataOptions.skip&&t.push(`$skip=${this._odataOptions.skip}`),this._odataOptions.orderBy){let e="";e=Array.isArray(this._odataOptions.orderBy)?this._odataOptions.orderBy.join(","):this._odataOptions.orderBy,t.push(`$orderby=${e}`)}if(this._odataOptions.filterBy||this._odataOptions.filter){const t=this._odataOptions.filter||this._odataOptions.filterBy;if(t){this._filterCount=1,this._odataOptions.filterQueue=[];let e=t;Array.isArray(t)&&(this._filterCount=t.length,e=t.join(` ${this._odataOptions.filterBySeparator||"and"} `)),"string"==typeof e&&("("!==e[0]||")"!==e.slice(-1)?this.addToFilterQueueWhenNotExists(`(${e})`):this.addToFilterQueueWhenNotExists(e))}}if(this._odataOptions.filterQueue.length>0){const e=this._odataOptions.filterQueue.join(` ${this._odataOptions.filterBySeparator||"and"} `);this._odataOptions.filter=e,t.push(`$filter=${e}`)}if(this._odataOptions.enableSelect||this._odataOptions.enableExpand){const e=this._columnDefinitions.flatMap((t=>t.fields??[t.field]));e.unshift(this._datasetIdPropName);const s=this.buildSelectExpand([...new Set(e)]);if(this._odataOptions.enableSelect){const e=s.selectParts.join(",");t.push(`$select=${e}`)}if(this._odataOptions.enableExpand){const e=s.expandParts.join(",");t.push(`$expand=${e}`)}}return t.join("&")}getFilterCount(){return this._filterCount}get columnFilters(){return this._columnFilters}get options(){return this._odataOptions}set options(t){this._odataOptions=t}removeColumnFilter(t){this._columnFilters&&this._columnFilters.hasOwnProperty(t)&&delete this._columnFilters[t]}saveColumnFilter(t,e,s){this._columnFilters[t]={search:s,value:e}}updateOptions(t){for(const e of Object.keys(t))if(t.hasOwnProperty(e)&&(this._odataOptions[e]=t[e]),"orderBy"===e||"sortBy"===e){let s=t[e];this._odataOptions.caseType===i.X3g.pascalCase&&(Array.isArray(s)?s.forEach(((t,e,s)=>{s[e]=(0,r.titleCase)(t)})):s=(0,r.titleCase)(t[e])),this._odataOptions.orderBy=s,this._defaultSortBy=s}}addToFilterQueueWhenNotExists(t){this._odataOptions.filterQueue&&-1===this._odataOptions.filterQueue.indexOf(t)&&this._odataOptions.filterQueue.push(t)}buildSelectExpand(t){const e={},s=new Set;for(const i of t){const t=i.split("/");if(1===t.length)s.add(i);else{const i=t[0],r=t.splice(1).join("/");e[i]||(e[i]=[]),e[i].push(r),!this._odataOptions.enableExpand||this._odataOptions.version&&this._odataOptions.version>=4||s.add(i)}}return{selectParts:[...s],expandParts:this._odataOptions.enableExpand?this.buildExpand(e):[]}}buildExpand(t){const e=[];for(const s of Object.keys(t))if(this._odataOptions.enableSelect&&this._odataOptions.version&&this._odataOptions.version>=4){const i=this.buildSelectExpand(t[s]);let r=i.selectParts.join(",");r.length>0&&(r="$select="+r),this._odataOptions.enableExpand&&i.expandParts.length>0&&(r+=(r.length>0?";":"")+"$expand="+i.expandParts.join(",")),r.length>0&&(r="("+r+")"),e.push(s+r)}else e.push(s);return e}}class o{get columnDefinitions(){return this._columnDefinitions}get odataService(){return this._odataService}get _gridOptions(){return this._grid?.getOptions()??{}}constructor(){this._currentFilters=[],this._currentPagination=null,this._currentSorters=[],this._columnDefinitions=[],this.defaultOptions={top:25,orderBy:"",caseType:i.X3g.pascalCase},this._odataService=new n}init(t,e,s,i){this._grid=s;const r={...this.defaultOptions,...t};if(this._gridOptions&&!this._gridOptions.enablePagination)this._odataService.options={...r,top:void 0},this._currentPagination=null;else{const t=e&&e.pageSize?e.pageSize:this.defaultOptions.top;this._odataService.options={...r,top:t},this._currentPagination={pageNumber:1,pageSize:this._odataService.options.top||this.defaultOptions.top||20}}if(this.options=this._odataService.options,this.pagination=e,s?.getColumns){const t=i?.allColumns??s.getColumns()??[];this._columnDefinitions=t.filter((t=>!t.excludeFromQuery))}this._odataService.columnDefinitions=this._columnDefinitions,this._odataService.datasetIdPropName=this._gridOptions.datasetIdPropertyName||"id"}buildQuery(){return this._odataService.buildQuery()}postProcess(t){const e=this._odataService.options.version??2;if(this.pagination&&this._odataService.options.enableCount){const s=(this._odataService.options.countExtractor??e>=4?t=>t?.["@odata.count"]:3===e?t=>t?.__count:t=>t?.d?.__count)(t);"number"==typeof s&&(this.pagination.totalItems=s)}if(this._odataService.options.enableExpand){const s=(this._odataService.options.datasetExtractor??e>=4?t=>t?.value:3===e?t=>t?.results:t=>t?.d?.results)(t);if(Array.isArray(s)){const t=new Set(this._columnDefinitions.flatMap((t=>t.fields??[t.field])).filter((t=>t.includes("/"))));if(t.size>0){const e=new Set;for(const i of s){for(const s of t){const t=s.split("/"),r=t[0];e.add(r);let n=i[r];for(let e=1;e<t.length;e++){const s=t[e];n&&"object"==typeof n&&s in n&&(n=n[s])}i[s]=n}for(const t of e)"object"==typeof i[t]&&delete i[t]}}}}}clearFilters(){this._currentFilters=[],this.updateFilters([])}clearSorters(){this._currentSorters=[],this.updateSorters([])}updateOptions(t){this.options={...this.options,...t},this._odataService.options=this.options}removeColumnFilter(t){this._odataService.removeColumnFilter(t)}getCurrentFilters(){return this._currentFilters}getCurrentPagination(){return this._currentPagination}getCurrentSorters(){return this._currentSorters}mapOdataOperator(t){let e="";switch(t){case"<":e="lt";break;case"<=":e="le";break;case">":e="gt";break;case">=":e="ge";break;case"<>":case"!=":e="ne";break;default:e="eq"}return e}resetPaginationOptions(){this._odataService.updateOptions({skip:0})}saveColumnFilter(t,e,s){this._odataService.saveColumnFilter(t,e,s)}processOnFilterChanged(t,e){if(void 0===this._gridOptions.backendServiceApi)throw new Error('Something went wrong in the GridOdataService, "backendServiceApi" is not initialized');if(this._currentFilters=this.castFilterToColumnFilters(e.columnFilters),!e||!e.grid)throw new Error('Something went wrong when trying create the GridOdataService, it seems that "args" is not populated correctly');return this.updateFilters(e.columnFilters),this.resetPaginationOptions(),this._odataService.buildQuery()}processOnPaginationChanged(t,e){const s=+(e.pageSize||(this.pagination?this.pagination.pageSize:20));return this.updatePagination(e.newPage,s),this._odataService.buildQuery()}processOnSortChanged(t,e){const s=e.multiColumnSort?e.sortCols:new Array({columnId:e.sortCol?.id??"",sortCol:e.sortCol,sortAsc:e.sortAsc});return this.updateSorters(s),this._odataService.buildQuery()}updateFilters(t,e){let s="";const n=[],o=this._odataService.options.version??2;e&&(this._currentFilters=this.castFilterToColumnFilters(t));for(const a in t)if(t.hasOwnProperty(a)){const h=t[a];let c;if(c=e&&Array.isArray(this._columnDefinitions)?this._columnDefinitions.find((t=>t.id===h.columnId)):h.columnDef,!c)throw new Error("[GridOData Service]: Something went wrong in trying to get the column definition of the specified filter (or preset filters). Did you make a typo on the filter columnId?");let l=c.filter?.queryField||c.queryFieldFilter||c.queryField||c.field||c.name||"";l instanceof HTMLElement&&(l=(0,r.stripTags)(l.innerHTML));const u=c.type||i.PUO.string;let d=(h?.searchTerms?[...h.searchTerms]:null)||[],p=Array.isArray(d)&&1===d.length?d[0]:"";if(void 0===p&&(p=""),!l)throw new Error('GridOData filter could not find the field name to query the search, your column definition must include a valid "field" or "name" (optionally you can also use the "queryfield").');if(this._odataService.options.useVerbatimSearchTerms||h.verbatimSearchTerms){n.push(`${l} ${h.operator} ${JSON.stringify(h.searchTerms)}`.trim());continue}p=null==p?"":`${p}`;const f=!1!==(c.autoParseInputFilterOperator??this._gridOptions.autoParseInputFilterOperator)?p.match(/^((.*[^\\*\r\n])[*]{1}(.*[^*\r\n]))|^([<>!=*]{0,2})(.*[^<>!=*])([*]?)$/)||[]:[p,"","","","",p,""],g=f?.[2]||"",m=f?.[3]||"";let y=h.operator||f?.[4],_=f?.[1]||f?.[5]||"";const O=f?.[6]||"*z"===y||y===i.huT.endsWith?"*":"",S=h.bypassBackendQuery||!1;if(l&&""===_&&d.length<=1){this.removeColumnFilter((0,r.getHtmlStringOutput)(l));continue}if(g&&m?(d=[g,m],y=i.huT.startsWithEndsWith):Array.isArray(d)&&1===d.length&&"string"==typeof d[0]&&d[0].indexOf("..")>=0&&(y!==i.huT.rangeInclusive&&y!==i.huT.rangeExclusive&&(y=this._gridOptions.defaultFilterRangeOperator??i.huT.rangeInclusive),d=d[0].split("..",2),""===d[0]?(y=y===i.huT.rangeInclusive?"<=":y===i.huT.rangeExclusive?"<":y,d=d.slice(1),_=d[0]):""===d[1]&&(y=y===i.huT.rangeInclusive?">=":y===i.huT.rangeExclusive?">":y,d=d.slice(0,1),_=d[0])),!y&&c.filter&&(y=c.filter.operator),!y&&Array.isArray(d)&&2===d.length&&d[0]&&d[1]&&(y=this._gridOptions.defaultFilterRangeOperator),y!==i.huT.rangeInclusive&&y!==i.huT.rangeExclusive||!Array.isArray(d)||1!==d.length||u!==i.PUO.date||(y=i.huT.equal),y||(y=(0,i.OIR)(u)),S)l&&this.saveColumnFilter((0,r.getHtmlStringOutput)(l),p,d);else{let t;if(_=this.normalizeSearchValue(u,_,o),Array.isArray(d)&&d.forEach(((t,e)=>{d[e]=this.normalizeSearchValue(u,d[e],o)})),s="",this._odataService.options.caseType===i.X3g.pascalCase&&(l=(0,r.titleCase)((0,r.getHtmlStringOutput)(l||""))),"function"==typeof this._odataService.options.filterQueryOverride&&(t=this._odataService.options.filterQueryOverride({fieldName:(0,r.getHtmlStringOutput)(l),columnDef:c,operator:y,columnFilterOperator:h.operator,searchValue:_,grid:this._grid})),void 0!==t)s=t;else if(y===i.huT.startsWithEndsWith&&Array.isArray(d)&&2===d.length){const t=[],[e,i]=d;t.push(`startswith(${l}, ${e})`),t.push(`endswith(${l}, ${i})`),s=t.join(" and ")}else if(d?.length>1&&("IN"===y||"NIN"===y||"NOTIN"===y||"NOT IN"===y||"NOT_IN"===y)){const t=[];if("IN"===y){for(let e=0,s=d.length;e<s;e++)t.push(`${l} eq ${d[e]}`);s=t.join(" or ")}else{for(let e=0,s=d.length;e<s;e++)t.push(`${l} ne ${d[e]}`);s=t.join(" and ")}"string"==typeof s&&"("===s[0]&&")"===s.slice(-1)||(s=`(${s})`)}else"*"===y||"a*"===y||"*z"===y||"*"===O||y===i.huT.startsWith||y===i.huT.endsWith?s="*"===y||"*z"===y||y===i.huT.endsWith?`endswith(${l}, ${_})`:`startswith(${l}, ${_})`:y===i.huT.rangeExclusive||y===i.huT.rangeInclusive?s=this.filterBySearchTermRange((0,r.getHtmlStringOutput)(l),y,d):""!==y&&y!==i.huT.contains&&y!==i.huT.notContains||u!==i.PUO.string&&u!==i.PUO.text&&u!==i.PUO.readonly?s=`${l} ${this.mapOdataOperator(y)} ${_}`:(s=o>=4?`contains(${l}, ${_})`:`substringof(${_}, ${l})`,y===i.huT.notContains&&(s=`not ${s}`));""!==s&&(n.push(s.trim()),this.saveColumnFilter((0,r.getHtmlStringOutput)(l||""),p,_))}}this._odataService.updateOptions({filter:n.length>0?n.join(" and "):"",skip:void 0})}updatePagination(t,e){this._currentPagination={pageNumber:t,pageSize:e},!this._gridOptions||!this._gridOptions.enablePagination&&this._gridOptions.hasOwnProperty("enablePagination")||this._odataService.updateOptions({top:e,skip:(t-1)*e})}updateSorters(t,e){let s=[];const n=[];if(!t&&e){s=e,s.forEach((t=>t.direction=t.direction.toLowerCase()));const t=s.map((t=>{const e=this._columnDefinitions.find((e=>e.id===t.columnId));return n.push({field:e?(e.queryFieldSorter||e.queryField||e.field)+"":t.columnId+"",direction:t.direction}),e?{columnId:t.columnId,sortAsc:t.direction.toUpperCase()===i.UEL.ASC}:null}));Array.isArray(t)&&this._grid&&this._grid.setSortColumns(t)}else if(t&&!e)if(0===t?.length);else if(t)for(const e of t)if(e.sortCol){let t=(e.sortCol.queryFieldSorter||e.sortCol.queryField||e.sortCol.field)+"",o=(e.sortCol.field||e.sortCol.id)+"",a=(e.sortCol.queryFieldSorter||e.sortCol.queryField||e.sortCol.field||"")+"";this._odataService.options.caseType===i.X3g.pascalCase&&(t=(0,r.titleCase)(t),o=(0,r.titleCase)(o),a=(0,r.titleCase)(a)),s.push({columnId:e.sortCol.id,direction:e.sortAsc?i.UEL.asc:i.UEL.desc}),""!==a&&n.push({field:a,direction:e.sortAsc?i.UEL.ASC:i.UEL.DESC})}s=s||[];const o=n.map((t=>{let e="";return t&&t.field&&(e=`${this._odataService.options.caseType===i.X3g.pascalCase?(0,r.titleCase)(t.field):t.field} ${t&&t.direction&&t.direction.toLowerCase()||""}`),e})).join(",");return this._odataService.updateOptions({orderBy:o}),this._currentSorters=s,this._odataService.buildQuery()}castFilterToColumnFilters(t){const e="object"==typeof t?Object.keys(t).map((e=>t[e])):t;return Array.isArray(e)?e.map((t=>{const e={columnId:t.columnId||""};return t.operator&&(e.operator=t.operator),t.targetSelector&&(e.targetSelector=t.targetSelector),Array.isArray(t.searchTerms)&&(e.searchTerms=t.searchTerms),e})):[]}filterBySearchTermRange(t,e,s){let r="";return Array.isArray(s)&&2===s.length&&(e===i.huT.rangeInclusive?(r=`(${t} ge ${s[0]}`,""!==s[1]&&(r+=` and ${t} le ${s[1]}`),r+=")"):e===i.huT.rangeExclusive&&(r=`(${t} gt ${s[0]}`,""!==s[1]&&(r+=` and ${t} lt ${s[1]}`),r+=")")),r}normalizeSearchValue(t,e,s){switch(t){case i.PUO.date:e=(0,i.Odt)(e),e=s>=4?e:`DateTime'${e}'`;break;case i.PUO.string:case i.PUO.text:case i.PUO.readonly:"string"==typeof e&&(e=e.replace(/'/g,"''"),e=`'${e=encodeURIComponent(e)}'`);break;case i.PUO.integer:case i.PUO.number:case i.PUO.float:"string"==typeof e&&(""!==(e=(e=(e=(e=(e=e.replace(/\.\./g,".")).replace(/\.+$/g,"")).replace(/^\.+/g,"0.")).replace(/^-+\.+/g,"-0.")).replace(/(?!^-)[^\d.]/g,""))&&"-"!==e||(e="0"))}return e}}},6972:(t,e,s)=>{s.d(e,{Pq:()=>r,xl:()=>d});var i=s(5522);function r(t,e){return JSON.stringify(void 0!==t?t:{},e)}class n{constructor(){this.cache=new Map,this.delete=t=>this.cache.delete(t),this.has=t=>this.cache.has(t),this.set=(t,e)=>this.cache.set(t,e),this.get=t=>this.cache.get(t),this.clear=()=>this.cache.clear()}}const o=i.DI.createInterface((t=>t.singleton(n)));class a{constructor(){this.baseUrl="",this.defaults={},this.interceptors=[],this.dispatcher=null,this.c=(0,i.hd)(i.p7)}withBaseUrl(t){return this.baseUrl=t,this}withDefaults(t){return this.defaults=t,this}withInterceptor(t){return this.interceptors.push(t),this}useStandardConfiguration(){return Object.assign(this.defaults,{credentials:"same-origin"},this.defaults),this.rejectErrorResponses()}rejectErrorResponses(){return this.withInterceptor({response:h})}withRetry(t){const e=this.c.invoke(P,[t]);return this.withInterceptor(e)}withDispatcher(t){return this.dispatcher=t,this}}function h(t){if(!t.ok)throw t;return t}const c=(t,...e)=>new Error(`AUR${String(t).padStart(4,"0")}:${e.map(String)}`),l=/^([a-z][a-z0-9+\-.]*:)?\/\//i,u=i.DI.createInterface("fetch",(t=>{if("function"!=typeof fetch)throw c(5e3);return t.instance(fetch)})),d=i.DI.createInterface("IHttpClient",(t=>t.aliasTo(p)));class p{constructor(){this.activeRequestCount=0,this.isRequesting=!1,this.isConfigured=!1,this.baseUrl="",this.defaults=null,this.t=[],this.i=null,this.h=(0,i.hd)((0,i.P9)(a)),this.u=(0,i.hd)(u)}get interceptors(){return this.t.slice(0)}configure(t){let e;if("object"==typeof t)e={defaults:t};else{if("function"!=typeof t)throw c(5002,typeof t);{e=this.h(),e.baseUrl=this.baseUrl,e.defaults={...this.defaults},e.interceptors=this.t,e.dispatcher=this.i;const s=t(e);if(null!=s){if("object"!=typeof s)throw c(5001,typeof s);e=s}}}const s=e.defaults;if(s?.headers instanceof Headers)throw c(5003);const i=e.interceptors;if(i?.length>0){if(i.filter((t=>t instanceof P)).length>1)throw c(5004);const t=i.findIndex((t=>t instanceof P));if(t>=0&&t!==i.length-1)throw c(5005)}return this.baseUrl=e.baseUrl,this.defaults=s,this.t=e.interceptors??[],this.i=e.dispatcher,this.isConfigured=!0,this}fetch(t,e){this.C();let s=this.buildRequest(t,e);return this.processRequest(s,this.t).then((t=>{let e;if(t instanceof Response)e=Promise.resolve(t);else{if(!(t instanceof Request))throw c(5006,t);s=t,e=this.u.call(void 0,s)}return this.processResponse(e,this.t,s)})).then((t=>t instanceof Request?this.fetch(t):t)).then((t=>(this.R(),t)),(t=>{throw this.R(),t}))}buildRequest(t,e){const s=this.defaults??{};let i,r,n;const o=function(t){const e={},s=t??{};for(const t of Object.keys(s))e[t]="function"==typeof s[t]?s[t]():s[t];return e}(s.headers);if(t instanceof Request)i=t,n=new Headers(i.headers).get("Content-Type");else{e||(e={}),r=e.body;const o=void 0!==r?{body:r}:null,a={...s,headers:{},...e,...o};n=new Headers(a.headers).get("Content-Type"),i=new Request(f(this.baseUrl,t),a)}return n||(new Headers(o).has("content-type")?i.headers.set("Content-Type",new Headers(o).get("content-type")):void 0!==r&&function(t){try{JSON.parse(t)}catch(t){return!1}return!0}(r)&&i.headers.set("Content-Type","application/json")),function(t,e){const s=e??{};for(const e of Object.keys(s))t.has(e)||t.set(e,s[e])}(i.headers,o),r instanceof Blob&&r.type&&i.headers.set("Content-Type",r.type),i}get(t,e){return this.fetch(t,e)}post(t,e,s){return this.I(t,e,s,"POST")}put(t,e,s){return this.I(t,e,s,"PUT")}patch(t,e,s){return this.I(t,e,s,"PATCH")}delete(t,e,s){return this.I(t,e,s,"DELETE")}dispose(){this.t.forEach((t=>t.dispose?.())),this.t.length=0,this.i=null}C(){this.isRequesting=!!++this.activeRequestCount,this.isRequesting&&null!=this.i&&y(this.i,_.started)}R(){this.isRequesting=!! --this.activeRequestCount,this.isRequesting||null==this.i||y(this.i,_.drained)}processRequest(t,e){return this.B(t,e,"request","requestError",Request,this)}processResponse(t,e,s){return this.B(t,e,"response","responseError",Response,s,this)}B(t,e,s,i,r,...n){return(e??[]).reduce(((t,e)=>{const o=e[s],a=e[i];return t.then(o?t=>t instanceof r?o.call(e,t,...n):t:g,a?t=>a.call(e,t,...n):m)}),Promise.resolve(t))}I(t,e,s,i){return s||(s={}),s.method=i,null!=e&&(s.body=e),this.fetch(t,s)}}function f(t,e){return l.test(e)?e:(t??"")+e}function g(t){return t}function m(t){throw t}function y(t,e){const s=new t.ownerDocument.defaultView.CustomEvent(e,{bubbles:!0,cancelable:!0});setTimeout((()=>{t.dispatchEvent(s)}),1)}const _=Object.freeze({started:"aurelia-fetch-client-request-started",drained:"aurelia-fetch-client-requests-drained"}),O=i.DI.createInterface((t=>t.singleton(C))),S=Object.freeze({Set:"au:fetch:cache:set",Get:"au:fetch:cache:get",Clear:"au:fetch:cache:clear",Reset:"au:fetch:cache:reset",Dispose:"au:fetch:cache:dispose",CacheHit:"au:fetch:cache:hit",CacheMiss:"au:fetch:cache:miss",CacheStale:"au:fetch:cache:stale",CacheStaleRefreshed:"au:fetch:cache:stale:refreshed",CacheExpired:"au:fetch:cache:expired",CacheBackgroundRefreshed:"au:fetch:cache:background:refreshed",CacheBackgroundRefreshing:"au:fetch:cache:background:refreshing",CacheBackgroundStopped:"au:fetch:cache:background:stopped"});class C{constructor(){this.storage=(0,i.hd)(o),this.p=(0,i.hd)(i.r_),this.ea=(0,i.hd)(i.xe),this.q=(0,i.hd)(d),this.H=[],this.O=-1,this.j=[],this.T=new Map}subscribe(t,e){const s=this.ea.subscribe(t,e);return this.H.push(s),s}subscribeOnce(t,e){const s=this.ea.subscribeOnce(t,e);return this.H.push(s),s}setStaleTimer(t,e,s){const i=this.p.setTimeout((async()=>{this.delete(t),await this.q.get(s);const e=this.getItem(t);this.ea.publish(S.CacheStaleRefreshed,{key:t,value:e}),this.N(i)}),e);this.j.push(i)}startBackgroundRefresh(t){!t||this.O>-1||(this.O=this.p.setInterval((()=>{this.ea.publish(S.CacheBackgroundRefreshing),this.T.forEach(((t,e)=>{this.delete(e),this.q.get(t).then((()=>{const t=this.getItem(e);this.ea.publish(S.CacheBackgroundRefreshed,{key:e,value:t})}))}))}),t))}stopBackgroundRefresh(){this.p.clearInterval(this.O),this.O=-1,this.ea.publish(S.CacheBackgroundStopped)}set(t,e,s,i){const r={data:e,...s};this.setItem(t,r,i)}get(t){return this.getItem(t)?.data}setItem(t,e,s){e.lastCached=Date.now(),this.storage.set(t,e),this.T.set(t,s),this.ea.publish(S.Set,{key:t,value:e})}getItem(t){if(!this.storage.has(t))return void this.ea.publish(S.CacheMiss,{key:t});const e=this.storage.get(t);if(!e?.staleTime||!e?.lastCached)return this.ea.publish(S.CacheHit,{key:t,value:e}),e;const s=Date.now();if(s>e.lastCached+(e.staleTime??0))this.ea.publish(S.CacheStale,{key:t,value:e});else{if(!(s>e.lastCached+(e.cacheTime??0)))return this.ea.publish(S.CacheHit,{key:t,value:e}),e;this.ea.publish(S.CacheExpired,{key:t,value:e})}}delete(t){this.storage.delete(t),this.ea.publish(S.Clear,{key:t})}clear(){this.storage.clear(),this.T.clear(),this.ea.publish(S.Reset),this.stopBackgroundRefresh(),this.j.forEach((t=>{this.p.clearTimeout(t)})),this.j.length=0}dispose(){this.clear(),this.H.forEach((t=>t.dispose())),this.ea.publish(S.Dispose)}N(t){this.p.clearTimeout(t);const e=this.j.indexOf(t);e>-1&&this.j.splice(e,1)}}const v={cacheTime:3e5,staleTime:0,refreshStaleImmediate:!1,refreshInterval:0};class b{constructor(t){this.P=(0,i.hd)(O),this.cf={...v,...t??{}}}request(t){if(this.P.startBackgroundRefresh(this.cf.refreshInterval),"GET"!==t.method)return t;const e=this.P.get(this.key(t));return this.mark(e)??t}response(t,e){if(!e)return t;if(t.headers.has(b.cacheHeader))return t;const s=this.key(e);return this.P.setItem(s,{data:t,...this.cf},e),this.cf?.refreshStaleImmediate&&this.cf.staleTime>0&&this.P.setStaleTimer(s,this.cf.staleTime,e),t}dispose(){this.P.stopBackgroundRefresh()}key(t){return`${b.prefix}${t.url}`}mark(t){return t?.headers.set(b.cacheHeader,"hit"),t}}b.prefix="au:interceptor:",b.cacheHeader="x-au-fetch-cache";class T{constructor(){this.cache=(0,i.hd)(i.r_).globalThis.indexedDB,this.getStore=()=>this.database.transaction(T.cacheName,"readwrite").objectStore(T.cacheName),this.delete=t=>{this.getStore().delete(t)},this.has=t=>this.getStore().count(t).result>0,this.set=(t,e)=>this.getStore().put(e,t),this.get=t=>this.getStore().get(t).result,this.clear=()=>{const t=this.getStore();t.getAllKeys().result.forEach((e=>{t.delete(e)}))},this.database=this.cache.open(T.cacheName).result}}T.cacheName="au-cache";const w=Object.freeze({fixed:0,incremental:1,exponential:2,random:3}),I={maxRetries:3,interval:1e3,strategy:w.fixed};class P{constructor(t){if(this.p=(0,i.hd)(i.r_),this.retryConfig={...I,...t??{}},this.retryConfig.strategy===w.exponential&&this.retryConfig.interval<=1e3)throw c(5007,this.retryConfig.interval)}request(t){return t.retryConfig||(t.retryConfig={...this.retryConfig},t.retryConfig.counter=0),t.retryConfig.requestClone=t.clone(),t}response(t,e){return delete e.retryConfig,t}responseError(t,e,s){const{retryConfig:i}=e,{requestClone:r}=i;return Promise.resolve().then((()=>{if(i.counter<i.maxRetries){const n=null==i.doRetry||i.doRetry(t,e);return Promise.resolve(n).then((n=>{if(n){i.counter++;const t=function(t){const{interval:e,strategy:s,minRandomInterval:i,maxRandomInterval:r,counter:n}=t;if("function"==typeof s)return t.strategy(n);switch(s){case w.fixed:return $[w.fixed](e);case w.incremental:return $[w.incremental](n,e);case w.exponential:return $[w.exponential](n,e);case w.random:return $[w.random](n,e,i,r);default:throw c(5008,s)}}(i);return new Promise((e=>this.p.setTimeout(e,isNaN(t)?0:t))).then((()=>{const t=r.clone();return"function"==typeof i.beforeRetry?i.beforeRetry(t,s):t})).then((t=>{const e={...t,retryConfig:i};return s.fetch(e)}))}throw delete e.retryConfig,t}))}throw delete e.retryConfig,t}))}}const $=[t=>t,(t,e)=>e*t,(t,e)=>1===t?e:e**t/1e3,(t,e,s=0,i=6e4)=>Math.random()*(i-s)+s]}}]);