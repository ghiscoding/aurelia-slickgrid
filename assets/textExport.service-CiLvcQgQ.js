import{h as d,j as S,k as T,D as b,l as C,m as E,s as _,o as A,p as H,q as R,u as G}from"./index-Bz3uuwsZ.js";function f(n,e,i){return e<=n&&n<=i}function O(n){if(n===void 0)return{};if(n===Object(n))return n;throw TypeError("Could not convert argument to dictionary")}function P(n){for(var e=String(n),i=e.length,t=0,s=[];t<i;){var r=e.charCodeAt(t);if(r<55296||r>57343)s.push(r);else if(56320<=r&&r<=57343)s.push(65533);else if(55296<=r&&r<=56319)if(t===i-1)s.push(65533);else{var a=n.charCodeAt(t+1);if(56320<=a&&a<=57343){var o=r&1023,l=a&1023;s.push(65536+(o<<10)+l),t+=1}else s.push(65533)}t+=1}return s}var y=-1;function w(n){this.tokens=[].slice.call(n)}w.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():y},prepend:function(n){if(Array.isArray(n))for(var e=n;e.length;)this.tokens.unshift(e.pop());else this.tokens.unshift(n)},push:function(n){if(Array.isArray(n))for(var e=n;e.length;)this.tokens.push(e.shift());else this.tokens.push(n)}};var x=-1,F="utf-8";function c(n,e){if(!(this instanceof c))return new c(n,e);if(n=n!==void 0?String(n).toLowerCase():F,n!==F)throw new Error("Encoding not supported. Only utf-8 is supported");e=O(e),this._streaming=!1,this._encoder=null,this._options={fatal:!!e.fatal},Object.defineProperty(this,"encoding",{value:"utf-8"})}c.prototype={encode:function(e,i){e=e?String(e):"",i=O(i),this._streaming||(this._encoder=new W(this._options)),this._streaming=!!i.stream;for(var t=[],s=new w(P(e)),r;!s.endOfStream()&&(r=this._encoder.handler(s,s.read()),r!==x);)Array.isArray(r)?t.push.apply(t,r):t.push(r);if(!this._streaming){for(;r=this._encoder.handler(s,s.read()),r!==x;)Array.isArray(r)?t.push.apply(t,r):t.push(r);this._encoder=null}return new Uint8Array(t)}};function W(n){n.fatal,this.handler=function(e,i){if(i===y)return x;if(f(i,0,127))return i;var t,s;f(i,128,2047)?(t=1,s=192):f(i,2048,65535)?(t=2,s=224):f(i,65536,1114111)&&(t=3,s=240);for(var r=[(i>>6*t)+s];t>0;){var a=i>>6*(t-1);r.push(128|a&63),t-=1}return r}}const k={delimiter:b.comma,filename:"export",format:d.csv,useUtf8WithBom:!0};class N{constructor(){this._delimiter=",",this._exportQuoteWrapper="",this._fileFormat=d.csv,this._lineCarriageReturn=`
`,this._columnHeaders=[],this._hasGroupedItems=!1,this.className="TextExportService"}get _datasetIdPropName(){return this._gridOptions&&this._gridOptions.datasetIdPropertyName||"id"}get _dataView(){var e;return(e=this._grid)==null?void 0:e.getData()}get _gridOptions(){var e;return((e=this._grid)==null?void 0:e.getOptions())??{}}dispose(){var e;(e=this._pubSubService)==null||e.unsubscribeAll()}init(e,i){var t;if(this._grid=e,this._pubSubService=i.get("PubSubService"),this._locales=this._gridOptions&&this._gridOptions.locales||S.locales,this._translaterService=(t=this._gridOptions)==null?void 0:t.translater,this._gridOptions.enableTranslate&&(!this._translaterService||!this._translaterService.translate))throw new Error('[Slickgrid-Universal] requires a Translate Service to be passed in the "translater" Grid Options when "enableTranslate" is enabled. (example: this.gridOptions = { enableTranslate: true, translater: this.translaterService })')}exportToFile(e){if(!this._grid||!this._dataView||!this._pubSubService)throw new Error('[Slickgrid-Universal] it seems that the SlickGrid & DataView objects and/or PubSubService are not initialized did you forget to enable the grid option flag "enableTextExport"?');return new Promise(i=>{var s;(s=this._pubSubService)==null||s.publish("onBeforeExportToTextFile",!0),this._exportOptions=T(!0,{},{...k,...this._gridOptions.textExportOptions,...e}),this._delimiter=this._exportOptions.delimiterOverride||this._exportOptions.delimiter||"",this._fileFormat=this._exportOptions.format||d.csv;const t=this.getDataOutput();window.setTimeout(()=>{var a;const r={filename:`${this._exportOptions.filename}.${this._fileFormat}`,format:this._fileFormat||d.csv,mimeType:this._exportOptions.mimeType||"text/plain",useUtf8WithBom:this._exportOptions&&this._exportOptions.hasOwnProperty("useUtf8WithBom")?this._exportOptions.useUtf8WithBom:!0};this.startDownloadFile({...r,content:t}),(a=this._pubSubService)==null||a.publish("onAfterExportToTextFile",r),i(!0)},0)})}startDownloadFile(e){const i=C(e.content);let t;e.format===d.csv?t=new c("utf-8").encode(i):t=i;const s=new Blob([e.useUtf8WithBom?"\uFEFF":"",t],{type:e.mimeType});if(typeof navigator.msSaveOrOpenBlob=="function")navigator.msSaveOrOpenBlob(s,e.filename);else{const r=document.createElement("a"),a=URL.createObjectURL(s);r.textContent="download",r.href=a,r.setAttribute("download",e.filename),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}getDataOutput(){var r,a,o;const e=this._grid.getColumns()||[];let i=this._exportOptions.groupingColumnHeaderTitle;!i&&this._gridOptions.enableTranslate&&((r=this._translaterService)!=null&&r.translate)&&((o=(a=this._translaterService)==null?void 0:a.getCurrentLanguage)!=null&&o.call(a))?i=this._translaterService.translate(`${E(this._gridOptions)}GROUP_BY`):i||(i=this._locales&&this._locales.TEXT_GROUP_BY),this._exportQuoteWrapper=this._fileFormat===d.csv?'"':"";let t="";const s=this._dataView.getGrouping();if(s&&Array.isArray(s)&&s.length>0?(this._hasGroupedItems=!0,t+=this._fileFormat===d.csv?`"${i}"${this._delimiter}`:`${i}${this._delimiter}`):this._hasGroupedItems=!1,this._gridOptions.createPreHeaderPanel&&this._gridOptions.showPreHeaderPanel&&!this._gridOptions.enableDraggableGrouping&&(this._groupedColumnHeaders=this.getColumnGroupedHeaderTitles(e)||[],this._groupedColumnHeaders&&Array.isArray(this._groupedColumnHeaders)&&this._groupedColumnHeaders.length>0)){const l=this._groupedColumnHeaders.map(h=>`${this._exportQuoteWrapper}${h.title}${this._exportQuoteWrapper}`);t+=l.join(this._delimiter)+this._lineCarriageReturn}if(this._columnHeaders=this.getColumnHeaders(e)||[],this._columnHeaders&&Array.isArray(this._columnHeaders)&&this._columnHeaders.length>0){const l=this._columnHeaders.map(h=>_(`${this._exportQuoteWrapper}${h.title}${this._exportQuoteWrapper}`));t+=l.join(this._delimiter)+this._lineCarriageReturn}return t+=this.getAllGridRowData(e,this._lineCarriageReturn),t}getAllGridRowData(e,i){const t=[],s=this._dataView.getLength();for(let r=0;r<s;r++){const a=this._dataView.getItem(r);a&&!a.hasOwnProperty("getItem")&&(a[this._datasetIdPropName]!==null&&a[this._datasetIdPropName]!==void 0?t.push(this.readRegularRowData(e,r,a)):this._hasGroupedItems&&a.__groupTotals===void 0?t.push(this.readGroupedTitleRow(a)):a.__groupTotals&&t.push(this.readGroupedTotalRow(e,a)))}return t.join(i)}getColumnGroupedHeaderTitles(e){const i=[];return e&&Array.isArray(e)&&e.forEach(t=>{var a,o,l;let s="";t.columnGroupKey&&this._gridOptions.enableTranslate&&((a=this._translaterService)!=null&&a.translate)&&((l=(o=this._translaterService)==null?void 0:o.getCurrentLanguage)!=null&&l.call(o))?s=this._translaterService.translate(t.columnGroupKey):s=t.columnGroup||"";const r=t.excludeFromExport||!1;(t.width===void 0||t.width>0)&&!r&&i.push({key:t.field||t.id,title:s||""})}),i}getColumnHeaders(e){const i=[];return e&&Array.isArray(e)&&e.forEach(t=>{var a,o,l;let s="";(t.nameKey||t.nameKey)&&this._gridOptions.enableTranslate&&((a=this._translaterService)!=null&&a.translate)&&((l=(o=this._translaterService)==null?void 0:o.getCurrentLanguage)!=null&&l.call(o))?s=this._translaterService.translate(t.nameKey||t.nameKey):s=A(t.name||"","innerHTML")||H(t.field);const r=t.excludeFromExport||!1;(t.width===void 0||t.width>0)&&!r&&i.push({key:t.field||t.id,title:s||""})}),i}readRegularRowData(e,i,t){let s=0;const r=[],a=this._exportQuoteWrapper;let o=1;const l=this._dataView.getItemMetadata(i);for(let h=0,m=e.length;h<m;h++){const u=e[h];if(u.excludeFromExport)continue;if(this._hasGroupedItems&&s===0){const p=this._fileFormat===d.csv?'""':"";r.push(p)}if(this._gridOptions.enableCellRowSpan){const p=this._grid.getParentRowSpanByCell(i,h,!1);if(p&&p.start!==i){r.push("");continue}}let v;if(l!=null&&l.columns){const p=l==null?void 0:l.columns,g=p[u.id]||p[h];!isNaN(o)&&+o>1||o==="*"&&h>0||(o=(g==null?void 0:g.colspan)??1),o!=="*"&&(u.id in p||h in p)&&(v=u.id)}if(o==="*"&&h>0||!isNaN(o)&&+o>1&&u.id!==v)r.push(""),!isNaN(o)&&+o>1&&o--;else{let p=R(i,h,u,t,this._grid,this._exportOptions);(u.sanitizeDataExport||this._exportOptions.sanitizeDataExport)&&(p=_(p)),this._fileFormat===d.csv&&p&&(p=p.toString().replace(/"/gi,'""'));const g=u!=null&&u.exportCsvForceToKeepAsString?"=":"";r.push(g+a+p+a)}s++}return r.join(this._delimiter)}readGroupedTitleRow(e){let i=_(e.title);const t=this._exportQuoteWrapper;return i=G(5*e.level)+i,this._fileFormat===d.csv&&(i=i.toString().replace(/"/gi,'""')),t+i+t}readGroupedTotalRow(e,i){const t=this._exportOptions.delimiter,s=this._exportOptions.format,r=this._exportOptions.groupingAggregatorRowText||"",a=this._exportQuoteWrapper,o=[`${a}${r}${a}`];return e.forEach(l=>{let h="";const m=l.excludeFromExport||!1;if(l.groupTotalsFormatter){const u=l.groupTotalsFormatter(i,l,this._grid);h=u instanceof HTMLElement?u.textContent||"":u}(l.sanitizeDataExport||this._exportOptions.sanitizeDataExport)&&(h=_(h)),s===d.csv&&(h=h.toString().replace(/"/gi,'""')),(l.width===void 0||l.width>0)&&!m&&o.push(a+h+a)}),o.join(t)}}export{N as T};
//# sourceMappingURL=textExport.service-CiLvcQgQ.js.map
