import{ax as C,p as m,s as T,a as g,O as u,o as v,ay as k,e as $,az as D}from"./index-Bz3uuwsZ.js";class Q{set columnDefinitions(i){this._columnDefinitions=i}set datasetIdPropName(i){this._datasetIdPropName=i}constructor(){this._filterCount=0,this._columnDefinitions=[],this._datasetIdPropName="id",this._odataOptions={filterQueue:[],orderBy:""},this._defaultSortBy="",this._columnFilters={}}buildQuery(){var t;if(!this._odataOptions)throw new Error('Odata Service requires certain options like "top" for it to work');this._odataOptions.filterQueue=[];const i=[];if(((t=this._odataOptions)==null?void 0:t.enableCount)===!0){const e=this._odataOptions.version&&this._odataOptions.version>=4?"$count=true":"$inlinecount=allpages";i.push(e)}if(this._odataOptions.top&&i.push(`$top=${this._odataOptions.top}`),this._odataOptions.skip&&i.push(`$skip=${this._odataOptions.skip}`),this._odataOptions.orderBy){let e="";Array.isArray(this._odataOptions.orderBy)?e=this._odataOptions.orderBy.join(","):e=this._odataOptions.orderBy,i.push(`$orderby=${e}`)}if(this._odataOptions.filterBy||this._odataOptions.filter){const e=this._odataOptions.filter||this._odataOptions.filterBy;if(e){this._filterCount=1,this._odataOptions.filterQueue=[];let n=e;Array.isArray(e)&&(this._filterCount=e.length,n=e.join(` ${this._odataOptions.filterBySeparator||"and"} `)),typeof n=="string"&&(n[0]==="("&&n.slice(-1)===")"?this.addToFilterQueueWhenNotExists(n):this.addToFilterQueueWhenNotExists(`(${n})`))}}if(this._odataOptions.filterQueue.length>0){const e=this._odataOptions.filterQueue.join(` ${this._odataOptions.filterBySeparator||"and"} `);this._odataOptions.filter=e,i.push(`$filter=${e}`)}if(this._odataOptions.enableSelect||this._odataOptions.enableExpand){const e=this._columnDefinitions.flatMap(o=>o.fields??[o.field]);e.unshift(this._datasetIdPropName);const n=this.buildSelectExpand([...new Set(e)]);if(this._odataOptions.enableSelect){const o=n.selectParts.join(",");i.push(`$select=${o}`)}if(this._odataOptions.enableExpand){const o=n.expandParts.join(",");i.push(`$expand=${o}`)}}return i.join("&")}getFilterCount(){return this._filterCount}get columnFilters(){return this._columnFilters}get options(){return this._odataOptions}set options(i){this._odataOptions=i}removeColumnFilter(i){this._columnFilters&&i in this._columnFilters&&delete this._columnFilters[i]}saveColumnFilter(i,t,e){this._columnFilters[i]={search:e,value:t}}updateOptions(i){for(const t of Object.keys(i))if(t in i&&(this._odataOptions[t]=i[t]),t==="orderBy"||t==="sortBy"){let e=i[t];this._odataOptions.caseType===C.pascalCase&&(Array.isArray(e)?e.forEach((n,o,s)=>{s[o]=m(n)}):e=m(i[t])),this._odataOptions.orderBy=e,this._defaultSortBy=e}}addToFilterQueueWhenNotExists(i){var t;((t=this._odataOptions.filterQueue)==null?void 0:t.indexOf(i))===-1&&this._odataOptions.filterQueue.push(i)}buildSelectExpand(i){const t={},e=new Set;for(const n of i){const o=n.split("/");if(o.length===1)e.add(n);else{const s=o[0],d=o.splice(1).join("/");t[s]||(t[s]=[]),t[s].push(d),this._odataOptions.enableExpand&&!(this._odataOptions.version&&this._odataOptions.version>=4)&&e.add(s)}}return{selectParts:[...e],expandParts:this._odataOptions.enableExpand?this.buildExpand(t):[]}}buildExpand(i){const t=[];for(const e of Object.keys(i))if(this._odataOptions.enableSelect&&this._odataOptions.version&&this._odataOptions.version>=4){const n=this.buildSelectExpand(i[e]);let o=n.selectParts.join(",");o.length>0&&(o="$select="+o),this._odataOptions.enableExpand&&n.expandParts.length>0&&(o+=(o.length>0?";":"")+"$expand="+n.expandParts.join(",")),o.length>0&&(o="("+o+")"),t.push(e+o)}else t.push(e);return t}}const B=25,x=20;class q{get columnDefinitions(){return this._columnDefinitions}get odataService(){return this._odataService}get _gridOptions(){var i;return((i=this._grid)==null?void 0:i.getOptions())??{}}constructor(){this._currentFilters=[],this._currentPagination=null,this._currentSorters=[],this._columnDefinitions=[],this.defaultOptions={top:B,orderBy:"",caseType:C.pascalCase},this._odataService=new Q}init(i,t,e,n){var s;this._grid=e;const o={...this.defaultOptions,...i};if(!this._gridOptions.enablePagination&&!(o!=null&&o.infiniteScroll))this._odataService.options={...o,top:void 0},this._currentPagination=null;else{const d=((s=o.infiniteScroll)==null?void 0:s.fetchSize)??(t==null?void 0:t.pageSize)??this.defaultOptions.top;this._odataService.options={...o,top:d},this._currentPagination={pageNumber:1,pageSize:this._odataService.options.top||this.defaultOptions.top||x}}if(this.options=this._odataService.options,this.pagination=t,e!=null&&e.getColumns){const d=(n==null?void 0:n.allColumns)??e.getColumns()??[];this._columnDefinitions=d.filter(l=>!l.excludeFromQuery)}this._odataService.columnDefinitions=this._columnDefinitions,this._odataService.datasetIdPropName=this._gridOptions.datasetIdPropertyName||"id"}buildQuery(){return this._odataService.buildQuery()}postProcess(i){const t=this._odataService.options.version??2;if(this.pagination&&this._odataService.options.enableCount){const n=(this._odataService.options.countExtractor??t>=4?o=>o==null?void 0:o["@odata.count"]:t===3?o=>o==null?void 0:o.__count:o=>{var s;return(s=o==null?void 0:o.d)==null?void 0:s.__count})(i);typeof n=="number"&&(this.pagination.totalItems=n)}if(this._odataService.options.enableExpand){const n=(this._odataService.options.datasetExtractor??t>=4?o=>o==null?void 0:o.value:t===3?o=>o==null?void 0:o.results:o=>{var s;return(s=o==null?void 0:o.d)==null?void 0:s.results})(i);if(Array.isArray(n)){const o=new Set(this._columnDefinitions.flatMap(s=>s.fields??[s.field]).filter(s=>s.includes("/")));if(o.size>0){const s=new Set;for(const d of n){for(const l of o){const c=l.split("/"),p=c[0];s.add(p);let h=d[p];for(let a=1;a<c.length;a++){const _=c[a];h&&typeof h=="object"&&_ in h&&(h=h[_])}d[l]=h}for(const l of s)typeof d[l]=="object"&&delete d[l]}}}}}clearFilters(){this._currentFilters=[],this.updateFilters([])}clearSorters(){this._currentSorters=[],this.updateSorters([])}updateOptions(i){this.options={...this.options,...i},this._odataService.options=this.options}removeColumnFilter(i){this._odataService.removeColumnFilter(i)}getCurrentFilters(){return this._currentFilters}getCurrentPagination(){return this._currentPagination}getCurrentSorters(){return this._currentSorters}mapOdataOperator(i){let t="";switch(i){case"<":t="lt";break;case"<=":t="le";break;case">":t="gt";break;case">=":t="ge";break;case"<>":case"!=":t="ne";break;case"=":case"==":default:t="eq";break}return t}resetPaginationOptions(){this._odataService.updateOptions({skip:0})}saveColumnFilter(i,t,e){this._odataService.saveColumnFilter(i,t,e)}processOnFilterChanged(i,t){if(this._gridOptions.backendServiceApi===void 0)throw new Error('Something went wrong in the GridOdataService, "backendServiceApi" is not initialized');if(this._currentFilters=this.castFilterToColumnFilters(t.columnFilters),!t||!t.grid)throw new Error('Something went wrong when trying create the GridOdataService, it seems that "args" is not populated correctly');return this.updateFilters(t.columnFilters),this.resetPaginationOptions(),this._odataService.buildQuery()}processOnPaginationChanged(i,t){var n,o;const e=+(((o=(n=this.options)==null?void 0:n.infiniteScroll)==null?void 0:o.fetchSize)||t.pageSize||(this.pagination?this.pagination.pageSize:x));return this.updatePagination(t.newPage,e),this._odataService.buildQuery()}processOnSortChanged(i,t){var n,o;const e=t.multiColumnSort?t.sortCols:new Array({columnId:((n=t.sortCol)==null?void 0:n.id)??"",sortCol:t.sortCol,sortAsc:t.sortAsc});return this.updateSorters(e),(o=this.options)!=null&&o.infiniteScroll&&this._odataService.updateOptions({skip:void 0}),this._odataService.buildQuery()}updateFilters(i,t){var s;let e="";const n=[],o=this._odataService.options.version??2;t&&(this._currentFilters=this.castFilterToColumnFilters(i));for(const d in i)if(i.hasOwnProperty(d)){const l=i[d];let c;if(t&&Array.isArray(this._columnDefinitions)?c=this._columnDefinitions.find(F=>F.id===l.columnId):c=l.columnDef,!c)throw new Error("[GridOData Service]: Something went wrong in trying to get the column definition of the specified filter (or preset filters). Did you make a typo on the filter columnId?");let p=((s=c.filter)==null?void 0:s.queryField)||c.queryFieldFilter||c.queryField||c.field||c.name||"";p instanceof HTMLElement&&(p=T(p.innerHTML));const h=c.type||g.string;let a=(l!=null&&l.searchTerms?[...l.searchTerms]:null)||[],_=Array.isArray(a)&&a.length===1?a[0]:"";if(typeof _>"u"&&(_=""),!p)throw new Error('GridOData filter could not find the field name to query the search, your column definition must include a valid "field" or "name" (optionally you can also use the "queryfield").');if(this._odataService.options.useVerbatimSearchTerms||l.verbatimSearchTerms){n.push(`${p} ${l.operator} ${JSON.stringify(l.searchTerms)}`.trim());continue}_=_==null?"":`${_}`;const f=(c.autoParseInputFilterOperator??this._gridOptions.autoParseInputFilterOperator)!==!1?_.match(/^((.*[^\\*\r\n])[*]{1}(.*[^*\r\n]))|^([<>!=*]{0,2})(.*[^<>!=*])([*]?)$/)||[]:[_,"","","","",_,""],A=(f==null?void 0:f[2])||"",E=(f==null?void 0:f[3])||"";let r=l.operator||(f==null?void 0:f[4]),O=(f==null?void 0:f[1])||(f==null?void 0:f[5])||"";const P=f!=null&&f[6]||r==="*z"||r===u.endsWith?"*":"",w=l.bypassBackendQuery||!1;if(p&&O===""&&a.length<=1){this.removeColumnFilter(v(p));continue}if(A&&E?(a=[A,E],r=u.startsWithEndsWith):Array.isArray(a)&&a.length===1&&typeof a[0]=="string"&&a[0].indexOf("..")>=0&&(r!==u.rangeInclusive&&r!==u.rangeExclusive&&(r=this._gridOptions.defaultFilterRangeOperator??u.rangeInclusive),a=a[0].split("..",2),a[0]===""?(r=r===u.rangeInclusive?"<=":r===u.rangeExclusive?"<":r,a=a.slice(1),O=a[0]):a[1]===""&&(r=r===u.rangeInclusive?">=":r===u.rangeExclusive?">":r,a=a.slice(0,1),O=a[0])),!r&&c.filter&&(r=c.filter.operator),!r&&Array.isArray(a)&&a.length===2&&a[0]&&a[1]&&(r=this._gridOptions.defaultFilterRangeOperator),(r===u.rangeInclusive||r===u.rangeExclusive)&&Array.isArray(a)&&a.length===1&&h===g.date&&(r=u.equal),r||(r=k(h)),w)p&&this.saveColumnFilter(v(p),_,a);else{O=this.normalizeSearchValue(h,O,o),Array.isArray(a)&&a.forEach((S,y)=>{a[y]=this.normalizeSearchValue(h,a[y],o)}),e="",this._odataService.options.caseType===C.pascalCase&&(p=m(v(p||"")));let F;if(typeof this._odataService.options.filterQueryOverride=="function"&&(F=this._odataService.options.filterQueryOverride({fieldName:v(p),columnDef:c,operator:r,columnFilterOperator:l.operator,searchValues:a,grid:this._grid})),F!==void 0)e=F;else if(r===u.startsWithEndsWith&&Array.isArray(a)&&a.length===2){const S=[],[y,b]=a;S.push(`startswith(${p}, ${y})`),S.push(`endswith(${p}, ${b})`),e=S.join(" and ")}else if((a==null?void 0:a.length)>1&&(r==="IN"||r==="NIN"||r==="NOTIN"||r==="NOT IN"||r==="NOT_IN")){const S=[];if(r==="IN"){for(let y=0,b=a.length;y<b;y++)S.push(`${p} eq ${a[y]}`);e=S.join(" or ")}else{for(let y=0,b=a.length;y<b;y++)S.push(`${p} ne ${a[y]}`);e=S.join(" and ")}typeof e=="string"&&e[0]==="("&&e.slice(-1)===")"||(e=`(${e})`)}else r==="*"||r==="a*"||r==="*z"||P==="*"||r===u.startsWith||r===u.endsWith?e=r==="*"||r==="*z"||r===u.endsWith?`endswith(${p}, ${O})`:`startswith(${p}, ${O})`:r===u.rangeExclusive||r===u.rangeInclusive?e=this.filterBySearchTermRange(v(p),r,a):(r===""||r===u.contains||r===u.notContains)&&(h===g.string||h===g.text||h===g.readonly)?(e=o>=4?`contains(${p}, ${O})`:`substringof(${O}, ${p})`,r===u.notContains&&(e=`not ${e}`)):e=`${p} ${this.mapOdataOperator(r)} ${O}`;e!==""&&(n.push(e.trim()),this.saveColumnFilter(v(p||""),_,O))}}this._odataService.updateOptions({filter:n.length>0?n.join(" and "):"",skip:void 0})}updatePagination(i,t){var e;this._currentPagination={pageNumber:i,pageSize:t},this._gridOptions&&(this._gridOptions.enablePagination||!this._gridOptions.hasOwnProperty("enablePagination")||(e=this.options)!=null&&e.infiniteScroll)&&this._odataService.updateOptions({top:t,skip:(i-1)*t})}updateSorters(i,t){let e=[];const n=[];if(!i&&t){e=t,e.forEach(d=>d.direction=d.direction.toLowerCase());const s=e.map(d=>{const l=this._columnDefinitions.find(c=>c.id===d.columnId);return n.push({field:l?(l.queryFieldSorter||l.queryField||l.field)+"":d.columnId+"",direction:d.direction}),l?{columnId:d.columnId,sortAsc:d.direction.toUpperCase()===$.ASC}:null});Array.isArray(s)&&this._grid&&this._grid.setSortColumns(s)}else if(i&&!t&&(i==null?void 0:i.length)!==0){if(i){for(const s of i)if(s.sortCol){let d=(s.sortCol.queryFieldSorter||s.sortCol.queryField||s.sortCol.field)+"",l=(s.sortCol.field||s.sortCol.id)+"",c=(s.sortCol.queryFieldSorter||s.sortCol.queryField||s.sortCol.field||"")+"";this._odataService.options.caseType===C.pascalCase&&(d=m(d),l=m(l),c=m(c)),e.push({columnId:s.sortCol.id,direction:s.sortAsc?$.asc:$.desc}),c!==""&&n.push({field:c,direction:s.sortAsc?$.ASC:$.DESC})}}}e=e||[];const o=n.map(s=>{let d="";return s&&s.field&&(d=`${this._odataService.options.caseType===C.pascalCase?m(s.field):s.field} ${s&&s.direction&&s.direction.toLowerCase()||""}`),d}).join(",");return this._odataService.updateOptions({orderBy:o}),this._currentSorters=e,this._odataService.buildQuery()}castFilterToColumnFilters(i){const t=typeof i=="object"?Object.keys(i).map(e=>i[e]):i;return Array.isArray(t)?t.map(e=>{const n={columnId:e.columnId||""};return e.operator&&(n.operator=e.operator),e.targetSelector&&(n.targetSelector=e.targetSelector),Array.isArray(e.searchTerms)&&(n.searchTerms=e.searchTerms),n}):[]}filterBySearchTermRange(i,t,e){let n="";return Array.isArray(e)&&e.length===2&&(t===u.rangeInclusive?(n=`(${i} ge ${e[0]}`,e[1]!==""&&(n+=` and ${i} le ${e[1]}`),n+=")"):t===u.rangeExclusive&&(n=`(${i} gt ${e[0]}`,e[1]!==""&&(n+=` and ${i} lt ${e[1]}`),n+=")")),n}normalizeSearchValue(i,t,e){switch(i){case g.date:t=D(t),t=e>=4?t:`DateTime'${t}'`;break;case g.string:case g.text:case g.readonly:typeof t=="string"&&(t=t.replace(/'/g,"''"),t=encodeURIComponent(t),t=`'${t}'`);break;case g.integer:case g.number:case g.float:typeof t=="string"&&(t=t.replace(/\.\./g,"."),t=t.replace(/\.+$/g,""),t=t.replace(/^\.+/g,"0."),t=t.replace(/^-+\.+/g,"-0."),t=t.replace(/(?!^-)[^\d.]/g,""),(t===""||t==="-")&&(t="0"));break}return t}}export{q as G};
//# sourceMappingURL=grid-odata.service-BpQYoHTV.js.map
