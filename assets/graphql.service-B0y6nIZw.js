import{s as T,a as y,o as S,O as u,ay as D,aA as v,e as b}from"./index-Bz3uuwsZ.js";class m{constructor(t,i){if(this.queryFnName=t,this.head=[],typeof i=="string")this.alias=i;else if(typeof i=="object")this.filter(i);else{if(i===void 0&&arguments.length===2)throw new TypeError('You have passed undefined as Second argument to "Query"');if(i!==void 0)throw new TypeError(`Second argument to "Query" should be an alias name(String) or filter arguments(Object). What was passed is: ${i}`)}}filter(t){for(const i of Object.keys(t)){if(typeof t[i]=="function")continue;const e=this.getGraphQLValue(t[i]);e!=="{}"&&this.head.push(`${i}:${e}`)}return this}find(...t){if(!t||!Array.isArray(t)||t.length===0)throw new TypeError("find value can not be >>falsy<<");const i=t.length===1&&Array.isArray(t[0])?t[0]:t;return this.body=this.parceFind(i),this}setAlias(t){this.alias=t}toString(){if(this.body===void 0)throw new ReferenceError("return properties are not defined. use the 'find' function to defined them");return`${this.alias?this.alias+":":""} ${this.queryFnName} ${this.head.length>0?"("+this.head.join(",")+")":""}  { ${this.body} }`}parceFind(t){return t.map((e,n)=>{const r=t[n];if(r instanceof m)return r.toString();if(!Array.isArray(r)&&typeof r=="object"){const p=Object.keys(r);if(p.length!==1)throw new RangeError(`Alias objects should only have one value. was passed: ${JSON.stringify(r)}`);const f=p[0],l=r[f];return Array.isArray(l)?new m(f).find(l):`${f} : ${l} `}else{if(typeof r=="string")return r;throw new RangeError(`cannot handle Find value of ${r}`)}}).join(",")}getGraphQLValue(t){return typeof t=="string"?t=JSON.stringify(t):Array.isArray(t)?(t=t.map(i=>this.getGraphQLValue(i)).join(),t=`[${t}]`):t instanceof Date?t=JSON.stringify(t):t!==null&&typeof t=="object"&&(t=this.objectToString(t)),t}objectToString(t){const i=[];for(const e of Object.keys(t))typeof t[e]!="function"&&i.push(`${e}:${this.getGraphQLValue(t[e])}`);return`{${i.join()}}`}}const E=25,Q=20;class j{constructor(){this._currentFilters=[],this._currentPagination=null,this._currentSorters=[],this._datasetIdPropName="id",this.defaultPaginationOptions={first:E,offset:0}}get columnDefinitions(){return this._columnDefinitions}get _gridOptions(){var t;return((t=this._grid)==null?void 0:t.getOptions())??{}}init(t,i,e,n){this._grid=e,this.options=t||{datasetName:""},this.pagination=i,this._datasetIdPropName=this._gridOptions.datasetIdPropertyName||"id",typeof(e==null?void 0:e.getColumns)=="function"&&(this._columnDefinitions=(n==null?void 0:n.allColumns)??e.getColumns()??[])}buildQuery(){var c,h,d,A,o,g,I;if(!this.options||!this.options.datasetName||!Array.isArray(this._columnDefinitions))throw new Error('GraphQL Service requires the "datasetName" property to properly build the GraphQL query');let t=this._columnDefinitions||[];t=t.filter(a=>!a.excludeFromQuery);const i=new m(`query ${this.options.operationName??""}`),e=new m(this.options.datasetName),n=new m("nodes"),r=[];if(Array.isArray(t))for(const a of t)a.excludeFieldFromQuery||r.push(a.field),a.fields&&r.push(...a.fields);r.indexOf(this._datasetIdPropName)===-1&&r.unshift(this._datasetIdPropName);const p=this.buildFilterQuery(r);let f=[];if(this._gridOptions.enablePagination!==!1||this.options.infiniteScroll){if(this.options.useCursor){const a=new m("edges"),_=new m("pageInfo");_.find("hasNextPage","hasPreviousPage","endCursor","startCursor"),n.find(p),a.find(["cursor"]),f=["totalCount",n,_,a]}else n.find(p),f=["totalCount",n];e.find(f)}else e.find(p);let l={};if(this._gridOptions.enablePagination!==!1||this.options.infiniteScroll)if(l={},this.options.useCursor&&this.options.paginationOptions)l={...this.options.paginationOptions};else{const a=(c=this.options)==null?void 0:c.paginationOptions;l.first=((d=(h=this.options)==null?void 0:h.infiniteScroll)==null?void 0:d.fetchSize)??((o=(A=this.options)==null?void 0:A.paginationOptions)==null?void 0:o.first)??((g=this.pagination)==null?void 0:g.pageSize)??this.defaultPaginationOptions.first,l.offset=a&&"offset"in a?+a.offset:0}if(this.options.sortingOptions&&Array.isArray(this.options.sortingOptions)&&this.options.sortingOptions.length>0&&(l.orderBy=this.options.sortingOptions),this.options.filteringOptions&&Array.isArray(this.options.filteringOptions)&&this.options.filteringOptions.length>0&&(l.filterBy=this.options.filteringOptions),this.options.addLocaleIntoQuery&&(l.locale=((I=this._gridOptions.translater)==null?void 0:I.getCurrentLanguage())||this._gridOptions.locale||"en"),this.options.extraQueryArguments)for(const a of this.options.extraQueryArguments)l[a.field]=a.value;e.filter(l),i.find(e);const O=["direction:","field:","operator:"];return this.trimDoubleQuotesOnEnumField(i.toString(),O,this.options.keepArgumentFieldDoubleQuotes||!1)}postProcess(t){var i;t.data&&this.pagination&&(this.pagination.totalItems=((i=t.data[this.getDatasetName()])==null?void 0:i.totalCount)||0)}buildFilterQuery(t){const i=(n={},r)=>{const p=r.shift();return n[p]=r.length?i(n[p]??{},r):null,n},e=t.reduce((n,r)=>i(n,r.split(".")),{});return JSON.stringify(e).replace(/"|:|null/g,"").replace(/^\{/,"").replace(/\}$/,"")}clearFilters(){this._currentFilters=[],this.updateOptions({filteringOptions:[]})}clearSorters(){this._currentSorters=[],this.updateOptions({sortingOptions:[]})}getInitPaginationOptions(){var i,e,n,r;const t=((e=(i=this.options)==null?void 0:i.infiniteScroll)==null?void 0:e.fetchSize)??((n=this.pagination)==null?void 0:n.pageSize)??E;return(r=this.options)!=null&&r.useCursor?{first:t}:{first:t,offset:0}}getDatasetName(){var t;return((t=this.options)==null?void 0:t.datasetName)||""}getCurrentFilters(){return this._currentFilters}getCurrentPagination(){return this._currentPagination}getCurrentSorters(){return this._currentSorters}resetPaginationOptions(){var i,e;let t;(i=this.options)!=null&&i.useCursor?t=this.getInitPaginationOptions():(t=this.options&&this.options.paginationOptions||this.getInitPaginationOptions(),t.offset=0),this._currentPagination={pageNumber:1,pageSize:t.first||Q},this._gridOptions&&(this._gridOptions.enablePagination||!("enablePagination"in this._gridOptions)||(e=this.options)!=null&&e.infiniteScroll)&&this.updateOptions({paginationOptions:t})}updateOptions(t){this.options={...this.options,...t}}processOnFilterChanged(t,i){if(this._gridOptions.backendServiceApi===void 0)throw new Error('Something went wrong in the GraphqlService, "backendServiceApi" is not initialized');if(this._currentFilters=this.castFilterToColumnFilters(i.columnFilters),!i||!i.grid)throw new Error('Something went wrong when trying create the GraphQL Backend Service, it seems that "args" is not populated correctly');return this.updateFilters(i.columnFilters,!1),this.resetPaginationOptions(),this.buildQuery()}processOnPaginationChanged(t,i){var n,r;const e=+(((r=(n=this.options)==null?void 0:n.infiniteScroll)==null?void 0:r.fetchSize)||i.pageSize||(this.pagination?this.pagination.pageSize:Q));return"first"in i||"last"in i?this.updatePagination(i.newPage,e,i):this.updatePagination(i.newPage,e),this.buildQuery()}processOnSortChanged(t,i){var n,r;const e=i.multiColumnSort?i.sortCols:new Array({columnId:((n=i.sortCol)==null?void 0:n.id)??"",sortCol:i.sortCol,sortAsc:i.sortAsc});return this.updateSorters(e),(r=this.options)!=null&&r.infiniteScroll&&this.updateOptions({paginationOptions:{offset:0}}),this.buildQuery()}updateFilters(t,i){var r,p,f,l;const e=[];let n;i&&(this._currentFilters=this.castFilterToColumnFilters(t));for(const O in t)if(O in t){const c=t[O];let h;if(i&&Array.isArray(this._columnDefinitions)?h=this._columnDefinitions.find(C=>C.id===c.columnId):h=c.columnDef,!h)throw new Error("[GraphQL Service]: Something went wrong in trying to get the column definition of the specified filter (or preset filters). Did you make a typo on the filter columnId?");let d=((r=h.filter)==null?void 0:r.queryField)||h.queryFieldFilter||h.queryField||h.field||h.name||"";d instanceof HTMLElement&&(d=T(d.innerHTML));const A=h.type||y.string;let o=(c==null?void 0:c.searchTerms)??[],g=Array.isArray(o)&&o.length===1?o[0]:"";if(typeof g>"u"&&(g=""),!d)throw new Error('GraphQL filter could not find the field name to query the search, your column definition must include a valid "field" or "name" (optionally you can also use the "queryfield").');if((p=this.options)!=null&&p.useVerbatimSearchTerms||c.verbatimSearchTerms){e.push({field:S(d),operator:c.operator,value:JSON.stringify(c.searchTerms)});continue}g=g==null?"":`${g}`;const a=(h.autoParseInputFilterOperator??this._gridOptions.autoParseInputFilterOperator)!==!1?g.match(/^((.*[^\\*\r\n])[*]{1}(.*[^*\r\n]))|^([<>!=*]{0,2})(.*[^<>!=*])([*]?)$/)||[]:[g,"","","","",g,""],_=(a==null?void 0:a[2])||"",w=(a==null?void 0:a[3])||"";let s=c.operator||(a==null?void 0:a[4]);n=(a==null?void 0:a[1])||(a==null?void 0:a[5])||"";const N=a!=null&&a[6]||s==="*z"||s===u.endsWith?"*":"";if(d&&n===""&&o.length===0)continue;let F;if(typeof((f=this.options)==null?void 0:f.filterQueryOverride)=="function"&&(F=(l=this.options)==null?void 0:l.filterQueryOverride({fieldName:S(d),columnDef:h,operator:s,columnFilterOperator:c.operator,searchValues:o,grid:this._grid})),F!==void 0)e.push(F);else{if(_&&w?(o=[_,w],s=u.startsWithEndsWith):Array.isArray(o)&&o.length===1&&typeof o[0]=="string"&&o[0].indexOf("..")>=0&&(s!==u.rangeInclusive&&s!==u.rangeExclusive&&(s=this._gridOptions.defaultFilterRangeOperator??u.rangeInclusive),o=o[0].split("..",2),o[0]===""?(s=s===u.rangeInclusive?"<=":s===u.rangeExclusive?"<":s,o=o.slice(1),n=o[0]):o[1]===""&&(s=s===u.rangeInclusive?">=":s===u.rangeExclusive?">":s,o=o.slice(0,1),n=o[0])),typeof n=="string"&&(s==="*"||s==="a*"||s==="*z"||N==="*")&&(s=s==="*"||s==="*z"?"EndsWith":"StartsWith"),!s&&h.filter&&h.filter.operator&&(s=h.filter.operator),!s&&Array.isArray(o)&&o.length===2&&o[0]&&o[1]&&(s=this._gridOptions.defaultFilterRangeOperator),(s===u.rangeInclusive||s===u.rangeExclusive)&&Array.isArray(o)&&o.length===1&&A===y.date&&(s=u.equal),n=this.normalizeSearchValue(A,n),Array.isArray(o)&&o.forEach((C,P)=>{o[P]=this.normalizeSearchValue(A,o[P])}),s===u.startsWithEndsWith&&Array.isArray(o)&&o.length===2){e.push({field:S(d),operator:u.startsWith,value:_}),e.push({field:S(d),operator:u.endsWith,value:w});continue}if((o==null?void 0:o.length)>1&&(s==="IN"||s==="NIN"||s==="NOT_IN"))n=o.join(",");else if((o==null?void 0:o.length)===2&&(s===u.rangeExclusive||s===u.rangeInclusive)){e.push({field:S(d),operator:s===u.rangeInclusive?"GE":"GT",value:o[0]}),e.push({field:S(d),operator:s===u.rangeInclusive?"LE":"LT",value:o[1]});continue}s||(s=D(A)),e.push({field:S(d),operator:v(s),value:n})}}this.updateOptions({filteringOptions:e})}updatePagination(t,i,e){var r;this._currentPagination={pageNumber:t,pageSize:i};let n={};if((r=this.options)!=null&&r.useCursor)if(e&&e instanceof Object){const{pageSize:p,newPage:f,...l}=e;n=l}else n={first:i};else n={first:i,offset:t>1?(t-1)*i:0};this.updateOptions({paginationOptions:n})}updateSorters(t,i){let e=[];const n=[];if(!t&&i){e=i,e.forEach(p=>p.direction=p.direction.toUpperCase());const r=e.map(p=>{var l;const f=(l=this._columnDefinitions)==null?void 0:l.find(O=>O.id===p.columnId);return n.push({field:f?(f.queryFieldSorter||f.queryField||f.field)+"":p.columnId+"",direction:p.direction}),f?{columnId:p.columnId,sortAsc:p.direction.toUpperCase()===b.ASC}:null});Array.isArray(r)&&this._grid&&this._grid.setSortColumns(r.filter(p=>p)||[])}else if(t&&!i&&Array.isArray(t)&&t.length>0){for(const r of t)if(r&&r.sortCol){e.push({columnId:r.sortCol.id+"",direction:r.sortAsc?b.ASC:b.DESC});const p=(r.sortCol.queryFieldSorter||r.sortCol.queryField||r.sortCol.field||"")+"";p&&n.push({field:p,direction:r.sortAsc?b.ASC:b.DESC})}}this._currentSorters=e,this.updateOptions({sortingOptions:n})}trimDoubleQuotesOnEnumField(t,i,e){const n='s?((field:s*)?".*?")';let r=i.join(n+"|");r+=n;const p=new RegExp(r,"g");return t.replace(p,f=>{let l=!0;return f.startsWith("field:")&&e&&(l=!1),l?f.replace(/"/g,""):f})}castFilterToColumnFilters(t){const i=typeof t=="object"?Object.keys(t).map(e=>t[e]):t;return Array.isArray(i)?i.map(e=>{const n={columnId:e.columnId||""};return e.operator&&(n.operator=e.operator),e.targetSelector&&(n.targetSelector=e.targetSelector),Array.isArray(e.searchTerms)&&(n.searchTerms=e.searchTerms),n}):[]}normalizeSearchValue(t,i){switch(t){case y.date:case y.string:case y.text:case y.readonly:typeof i=="string"&&(i=i.replace(/'/g,"''"));break;case y.integer:case y.number:case y.float:typeof i=="string"&&(i=i.replace(/\.\./g,"."),i=i.replace(/\.+$/g,""),i=i.replace(/^\.+/g,"0."),i=i.replace(/^-+\.+/g,"-0."),i=i.replace(/(?!^-)[^\d.]/g,""),(i===""||i==="-")&&(i="0"));break}return i}}export{j as G};
//# sourceMappingURL=graphql.service-B0y6nIZw.js.map
